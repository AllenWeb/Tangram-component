<?xml version="1.0" encoding="UTF-8"?>
<project name="project" default="getreport" basedir="../../">
	<!-- 配置信息 10.32.34.115:8000-->
	<property name="serverip" value="10.32.34.115:8000" />
	<property name="report.path" value="test/tools/br/report" />
	<property name="coverage.path" value="test/coverage" />
	<property name="report.file" value="test/tools/br/report.xml" />
	<property name="git.project" value="Tangram-component" />
	<property name="git.user" value="" />

	<property name="report.style.path" value="test/tools/br/report/style" />
	<property name="report.html.path" value="${report.path}/html" />

	<path id="ext.classpath">
		<fileset dir="test/tools/lib">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<!--为hudson做的扩展，用于支持多用户运行环境，会直接提取当前项目的父目录名称作为user-->
	<taskdef name="gitext" classname="com.baidu.tangram.GitExt" classpathref="ext.classpath" />

	<target name="init">
		<gitext />
		<delete dir="${report.path}" />
		<delete file="${report.file}" />
	</target>

	<target name="coverage">
		<delete dir="${coverage.path}" />
		<exec executable="jscoverage">
			<arg value="--encoding=UTF-8" />
			<arg value="src" />
			<arg value="${coverage.path}" />
		</exec>
	</target>

	<target name="execute" depends="init,coverage">
		<get src="http://${serverip}/${git.user}/${git.project}/test/tools/br/runall.php?ci=true&amp;cov=true" dest="/tmp/${git.user}_${git.project}.php" />
	</target>
	<target name="getreport" depends="execute">
		<waitfor maxwait="600" maxwaitunit="second">
			<available file="${report.file}" />
		</waitfor>

	</target>
	<!-- 
		mail brief info
		mail user should be pass from command line for multi user support
	-->
	<target name="checkmailuser">
		<condition property="git.user.mail" />
	</target>
	<target name="mail" depends="checkmailuser, getreport">
		<!--generate html report by junit report-->
		<mkdir dir="${report.html.path}" />
		<junitreport todir="${report.html.path}">
			<fileset dir="${report.path}">
				<include name="*.xml" />
			</fileset>
			<!-- brief report for mail message -->
			<report format="noframes" styledir="${report.style.path}/brief" todir="${report.html.path}/brief" />
			<!-- detail report for mail attachements 
			<report format="noframes" styledir="${report.style.path}/detail" todir="${report.html.path}/detail" />-->
		</junitreport>
		<!--send mail from hotswap-c-->
		<loadfile property="report.html" srcFile="${report.style.path}/brief/junit-noframes.html" />
		<mail mailhost="hotswap-c.baidu.com" charset="UTF-8" messagemimetype="text/html" subject="build from ci">
			<to address="${git.user.mail}" />
			<from address="yangbo@baidu.com" />
			<cc address="yangbo@baidu.com" />
			<message>${report.html}
				&lt;br/&gt;see detail report from &lt;a href="" &gt;ci link&lt;/&gt;</message>
			<!--
			<attachments>
				<fileset dir="${report.html.path}/detail">
					<include name="**/*" />
					<exclude name="" />
				</fileset>
			</attachments>-->
		</mail>
	</target>
</project>